<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriverParty - Cliente</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Barra superior con próxima instrucción -->
    <div id="instruction-bar" class="instruction-bar">
        <div class="instruction-content">
            <i class="fas fa-route"></i>
            <span id="next-instruction">Esperando conductor...</span>
        </div>
        <div class="instruction-actions">
            <button id="recenter-btn" class="action-btn" title="Recentar mapa">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button id="google-maps-btn" class="action-btn" title="Abrir en Google Maps">
                <i class="fab fa-google"></i>
            </button>
        </div>
    </div>

    <!-- Panel lateral con lista de pasos -->
    <div id="steps-panel" class="steps-panel">
        <div class="steps-header">
            <h3>Instrucciones de navegación</h3>
            <button id="toggle-steps-btn" class="toggle-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div id="steps-list" class="steps-list">
            <!-- Los pasos se cargarán dinámicamente -->
        </div>
    </div>

    <!-- Mapa principal -->
    <div id="map" class="map-container"></div>

    <!-- Panel de configuración del viaje -->
    <div id="trip-setup-panel" class="trip-setup-panel">
        <div class="setup-header">
            <h3>Configurar viaje</h3>
        </div>
        <div class="setup-content">
            <div class="form-group">
                <label for="pickup-input">Punto de partida</label>
                <div class="input-group">
                    <input type="text" id="pickup-input" placeholder="¿Desde dónde sales?" />
                    <button id="search-pickup-btn" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="pickup-suggestions" id="pickup-suggestions"></div>
            <div class="selected-pickup" id="selected-pickup" style="display: none;">
                <div class="pickup-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="selected-pickup-text"></span>
                </div>
                <button id="change-pickup-btn" class="change-btn">
                    <i class="fas fa-edit"></i>
                    Cambiar
                </button>
            </div>
            
            <div class="form-group">
                <label for="destination-input">Destino</label>
                <div class="input-group">
                    <input type="text" id="destination-input" placeholder="¿A dónde vas?" />
                    <button id="search-destination-btn" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="destination-suggestions" id="destination-suggestions"></div>
            <div class="selected-destination" id="selected-destination" style="display: none;">
                <div class="destination-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="selected-destination-text"></span>
                </div>
                <button id="change-destination-btn" class="change-btn">
                    <i class="fas fa-edit"></i>
                    Cambiar
                </button>
            </div>
            <div class="setup-actions">
                <button id="create-trip-btn" class="action-btn primary" disabled>
                    <i class="fas fa-car"></i>
                    Solicitar viaje
                </button>
            </div>
        </div>
    </div>

    <!-- Panel de información del viaje -->
    <div id="trip-info-panel" class="trip-info-panel" style="display: none;">
        <div class="trip-status">
            <div id="trip-status" class="status-indicator">
                <i class="fas fa-clock"></i>
                <span>Esperando conductor...</span>
            </div>
        </div>
        
        <div class="driver-info" id="driver-info" style="display: none;">
            <div class="driver-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="driver-details">
                <div class="driver-name" id="driver-name">Conductor</div>
                <div class="driver-eta" id="driver-eta">--</div>
            </div>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../src/firebase.js"></script>
    <script type="module" src="../src/maps.js"></script>
    <script type="module" src="../src/directions.js"></script>
    <script type="module" src="../src/location.js"></script>
    <script type="module" src="../src/trips.js"></script>
    <script type="module" src="../src/utils.js"></script>
    
    <script type="module">
        import { db, auth } from '../src/firebase.js';
        import { createMap } from '../src/maps.js';
        import { listenTrip, listenDriverPresence } from '../src/trips.js';
        import { formatInstruction } from '../src/utils.js';

        // Estado global
        let tripId = null;
        let tripData = null;
        let mapInstance = null;
        let driverPresence = null;

        // Elementos del DOM
        const instructionBar = document.getElementById('instruction-bar');
        const nextInstruction = document.getElementById('next-instruction');
        const stepsPanel = document.getElementById('steps-panel');
        const stepsList = document.getElementById('steps-list');
        const toggleStepsBtn = document.getElementById('toggle-steps-btn');
        const mapContainer = document.getElementById('map');
        const tripSetupPanel = document.getElementById('trip-setup-panel');
        const tripInfoPanel = document.getElementById('trip-info-panel');
        const tripStatus = document.getElementById('trip-status');
        const driverInfo = document.getElementById('driver-info');
        
        // Elementos del panel de configuración
        const pickupInput = document.getElementById('pickup-input');
        const searchPickupBtn = document.getElementById('search-pickup-btn');
        const pickupSuggestions = document.getElementById('pickup-suggestions');
        const selectedPickup = document.getElementById('selected-pickup');
        const selectedPickupText = document.getElementById('selected-pickup-text');
        const changePickupBtn = document.getElementById('change-pickup-btn');
        
        const destinationInput = document.getElementById('destination-input');
        const searchDestinationBtn = document.getElementById('search-destination-btn');
        const destinationSuggestions = document.getElementById('destination-suggestions');
        const selectedDestination = document.getElementById('selected-destination');
        const selectedDestinationText = document.getElementById('selected-destination-text');
        const changeDestinationBtn = document.getElementById('change-destination-btn');
        const createTripBtn = document.getElementById('create-trip-btn');
        
        // Estado del pickup y destino
        let selectedPickupData = null;
        let selectedDestinationData = null;
        const driverName = document.getElementById('driver-name');
        const driverEta = document.getElementById('driver-eta');
        const recenterBtn = document.getElementById('recenter-btn');
        const googleMapsBtn = document.getElementById('google-maps-btn');
        const loading = document.getElementById('loading');

        // Inicialización
        async function init() {
            // Obtener tripId de la URL
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            
            // Inicializar mapa
            try {
                mapInstance = await createMap('map');
                console.log('Mapa inicializado');
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                alert('Error al cargar el mapa');
                return;
            }
            
            // Verificar si es un viaje nuevo
            const isNewTrip = urlParams.get('new') === 'true';
            
            if (isNewTrip) {
                // Generar nuevo tripId
                tripId = generateTripId();
                
                // Configurar para nuevo viaje
                setupNewTrip();
            } else if (tripId) {
                // Unirse a viaje existente
                joinExistingTrip();
            } else {
                alert('No se proporcionó un ID de viaje válido');
                window.location.href = 'index.html';
                return;
            }
            
            // Event listeners
            setupEventListeners();
            
            // Ocultar loading
            loading.style.display = 'none';
        }

        // Generar ID único para el viaje
        function generateTripId() {
            const timestamp = Date.now();
            const randomId = Math.random().toString(36).substring(2, 10);
            return `trip_${timestamp}_${randomId}`;
        }

        // Unirse a viaje existente
        function joinExistingTrip() {
            // Mostrar panel de información del viaje
            tripSetupPanel.style.display = 'none';
            tripInfoPanel.style.display = 'block';
            
            // Escuchar cambios en el viaje
            listenTrip(tripId, handleTripUpdate);
            
            // Escuchar presencia del conductor
            listenDriverPresence(tripId, handleDriverPresence);
        }

        // Configurar para nuevo viaje
        function setupNewTrip() {
            // Mostrar panel de configuración
            tripSetupPanel.style.display = 'block';
            tripInfoPanel.style.display = 'none';
            
            // Centrar mapa en Montevideo por defecto
            const defaultLocation = { lat: -34.9011, lng: -56.1645 }; // Montevideo
            mapInstance.map.setCenter(defaultLocation);
            mapInstance.map.setZoom(12);
        }

        // Buscar punto de partida
        async function searchPickup() {
            const query = pickupInput.value.trim();
            if (!query) return;
            
            try {
                const suggestions = await searchPlaces(query);
                showPickupSuggestions(suggestions);
            } catch (error) {
                console.error('Error buscando punto de partida:', error);
                alert('Error al buscar punto de partida');
            }
        }

        // Buscar destino
        async function searchDestination() {
            const query = destinationInput.value.trim();
            if (!query) return;
            
            try {
                const suggestions = await searchPlaces(query);
                showDestinationSuggestions(suggestions);
            } catch (error) {
                console.error('Error buscando destino:', error);
                alert('Error al buscar destino');
            }
        }

        // Manejar input de pickup
        function handlePickupInput() {
            const query = pickupInput.value.trim();
            if (query.length > 2) {
                // Auto-búsqueda después de 3 caracteres
                setTimeout(() => {
                    if (pickupInput.value.trim() === query) {
                        searchPickup();
                    }
                }, 500);
            } else {
                hidePickupSuggestions();
            }
        }

        // Manejar input de destino
        function handleDestinationInput() {
            const query = destinationInput.value.trim();
            if (query.length > 2) {
                // Auto-búsqueda después de 3 caracteres
                setTimeout(() => {
                    if (destinationInput.value.trim() === query) {
                        searchDestination();
                    }
                }, 500);
            } else {
                hideDestinationSuggestions();
            }
        }

        // Buscar lugares usando Google Places API
        async function searchPlaces(query) {
            return new Promise((resolve, reject) => {
                if (!window.google || !window.google.maps) {
                    reject(new Error('Google Maps API no disponible'));
                    return;
                }
                
                const service = new google.maps.places.AutocompleteService();
                service.getPlacePredictions({
                    input: query,
                    types: ['establishment', 'geocode']
                }, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                        resolve(predictions);
                    } else {
                        resolve([]);
                    }
                });
            });
        }

        // Mostrar sugerencias de pickup
        function showPickupSuggestions(suggestions) {
            pickupSuggestions.innerHTML = '';
            
            if (suggestions.length === 0) {
                pickupSuggestions.innerHTML = '<div class="suggestion-item">No se encontraron resultados</div>';
            } else {
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <div class="suggestion-text">${suggestion.structured_formatting.main_text}</div>
                        <div class="suggestion-address">${suggestion.structured_formatting.secondary_text}</div>
                    `;
                    item.addEventListener('click', () => selectPickup(suggestion));
                    pickupSuggestions.appendChild(item);
                });
            }
            
            pickupSuggestions.classList.add('show');
        }

        // Mostrar sugerencias de destino
        function showDestinationSuggestions(suggestions) {
            destinationSuggestions.innerHTML = '';
            
            if (suggestions.length === 0) {
                destinationSuggestions.innerHTML = '<div class="suggestion-item">No se encontraron resultados</div>';
            } else {
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <div class="suggestion-text">${suggestion.structured_formatting.main_text}</div>
                        <div class="suggestion-address">${suggestion.structured_formatting.secondary_text}</div>
                    `;
                    item.addEventListener('click', () => selectDestination(suggestion));
                    destinationSuggestions.appendChild(item);
                });
            }
            
            destinationSuggestions.classList.add('show');
        }

        // Ocultar sugerencias de pickup
        function hidePickupSuggestions() {
            pickupSuggestions.classList.remove('show');
        }

        // Ocultar sugerencias de destino
        function hideDestinationSuggestions() {
            destinationSuggestions.classList.remove('show');
        }

        // Seleccionar pickup
        async function selectPickup(suggestion) {
            try {
                const placeDetails = await getPlaceDetails(suggestion.place_id);
                selectedPickupData = {
                    lat: placeDetails.geometry.location.lat(),
                    lng: placeDetails.geometry.location.lng(),
                    address: suggestion.description,
                    name: suggestion.structured_formatting.main_text
                };
                
                // Mostrar pickup seleccionado
                selectedPickupText.textContent = selectedPickupData.address;
                selectedPickup.style.display = 'flex';
                pickupInput.style.display = 'none';
                searchPickupBtn.style.display = 'none';
                hidePickupSuggestions();
                
                // Verificar si se puede habilitar el botón de crear viaje
                checkCreateTripButton();
                
                // Agregar marcador en el mapa
                addPickupMarker(selectedPickupData);
                
            } catch (error) {
                console.error('Error seleccionando pickup:', error);
                alert('Error al seleccionar punto de partida');
            }
        }

        // Seleccionar destino
        async function selectDestination(suggestion) {
            try {
                const placeDetails = await getPlaceDetails(suggestion.place_id);
                selectedDestinationData = {
                    lat: placeDetails.geometry.location.lat(),
                    lng: placeDetails.geometry.location.lng(),
                    address: suggestion.description,
                    name: suggestion.structured_formatting.main_text
                };
                
                // Mostrar destino seleccionado
                selectedDestinationText.textContent = selectedDestinationData.address;
                selectedDestination.style.display = 'flex';
                destinationInput.style.display = 'none';
                searchDestinationBtn.style.display = 'none';
                hideDestinationSuggestions();
                
                // Verificar si se puede habilitar el botón de crear viaje
                checkCreateTripButton();
                
                // Agregar marcador en el mapa
                addDestinationMarker(selectedDestinationData);
                
            } catch (error) {
                console.error('Error seleccionando destino:', error);
                alert('Error al seleccionar destino');
            }
        }

        // Obtener detalles del lugar usando PlacesService
        async function getPlaceDetails(placeId) {
            return new Promise((resolve, reject) => {
                const service = new google.maps.places.PlacesService(mapInstance.map);
                service.getDetails({
                    placeId: placeId,
                    fields: ['geometry', 'formatted_address']
                }, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                        resolve(place);
                    } else {
                        reject(new Error('No se pudieron obtener los detalles del lugar'));
                    }
                });
            });
        }

        // Helper function to create markers with AdvancedMarkerElement fallback
        function createMarker(options) {
            // Check if AdvancedMarkerElement is available and map is properly initialized
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && options.map && options.map.getMapId) {
                try {
                    // Create AdvancedMarkerElement
                    const markerElement = document.createElement('div');
                    markerElement.innerHTML = options.icon?.url || '📍';
                    markerElement.style.fontSize = '24px';
                    markerElement.style.cursor = 'pointer';
                    
                    return new google.maps.marker.AdvancedMarkerElement({
                        position: options.position,
                        map: options.map,
                        title: options.title,
                        content: markerElement
                    });
                } catch (error) {
                    console.warn('Error creating AdvancedMarkerElement, falling back to traditional Marker:', error);
                    return new google.maps.Marker(options);
                }
            } else {
                // Fallback to traditional Marker
                return new google.maps.Marker(options);
            }
        }

        // Agregar marcador de pickup en el mapa
        function addPickupMarker(pickup) {
            if (mapInstance.pickupMarker) {
                mapInstance.pickupMarker.setMap(null);
            }
            
            const pickupIcon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#4CAF50"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(24, 24),
                anchor: new google.maps.Point(12, 24)
            };
            
            mapInstance.pickupMarker = createMarker({
                position: { lat: pickup.lat, lng: pickup.lng },
                map: mapInstance.map,
                title: pickup.name,
                icon: pickupIcon
            });
            
            // Ajustar vista del mapa para mostrar pickup y destino
            adjustMapBounds();
        }

        // Agregar marcador de destino en el mapa
        function addDestinationMarker(destination) {
            if (mapInstance.destinationMarker) {
                mapInstance.destinationMarker.setMap(null);
            }
            
            const destinationIcon = {
                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#9c27b0"/>
                    </svg>
                `),
                scaledSize: new google.maps.Size(24, 24),
                anchor: new google.maps.Point(12, 24)
            };
            
            mapInstance.destinationMarker = createMarker({
                position: { lat: destination.lat, lng: destination.lng },
                map: mapInstance.map,
                title: destination.name,
                icon: destinationIcon
            });
            
            // Ajustar vista del mapa para mostrar pickup y destino
            adjustMapBounds();
        }

        // Ajustar vista del mapa para mostrar pickup y destino
        function adjustMapBounds() {
            const bounds = new google.maps.LatLngBounds();
            
            if (selectedPickupData) {
                bounds.extend({ lat: selectedPickupData.lat, lng: selectedPickupData.lng });
            }
            
            if (selectedDestinationData) {
                bounds.extend({ lat: selectedDestinationData.lat, lng: selectedDestinationData.lng });
            }
            
            if (bounds.isEmpty()) {
                // Si no hay marcadores, centrar en Montevideo
                const defaultLocation = { lat: -34.9011, lng: -56.1645 };
                mapInstance.map.setCenter(defaultLocation);
                mapInstance.map.setZoom(12);
            } else {
                mapInstance.map.fitBounds(bounds);
                mapInstance.map.setZoom(Math.min(mapInstance.map.getZoom(), 15));
            }
        }

        // Verificar si se puede habilitar el botón de crear viaje
        function checkCreateTripButton() {
            createTripBtn.disabled = !(selectedPickupData && selectedDestinationData);
        }

        // Resetear pickup
        function resetPickup() {
            selectedPickupData = null;
            selectedPickup.style.display = 'none';
            pickupInput.style.display = 'block';
            searchPickupBtn.style.display = 'block';
            pickupInput.value = '';
            checkCreateTripButton();
            hidePickupSuggestions();
            
            // Remover marcador de pickup
            if (mapInstance.pickupMarker) {
                mapInstance.pickupMarker.setMap(null);
                mapInstance.pickupMarker = null;
            }
            
            adjustMapBounds();
        }

        // Resetear destino
        function resetDestination() {
            selectedDestinationData = null;
            selectedDestination.style.display = 'none';
            destinationInput.style.display = 'block';
            searchDestinationBtn.style.display = 'block';
            destinationInput.value = '';
            checkCreateTripButton();
            hideDestinationSuggestions();
            
            // Remover marcador de destino
            if (mapInstance.destinationMarker) {
                mapInstance.destinationMarker.setMap(null);
                mapInstance.destinationMarker = null;
            }
            
            adjustMapBounds();
        }

        // Crear viaje con pickup y destino seleccionados
        async function createTripWithDestination() {
            if (!selectedPickupData) {
                alert('Por favor selecciona un punto de partida');
                return;
            }
            
            if (!selectedDestinationData) {
                alert('Por favor selecciona un destino');
                return;
            }
            
            try {
                const { createTrip } = await import('../src/trips.js');
                
                const tripData = {
                    tripId: tripId,
                    clientId: auth.currentUser?.uid || 'anonymous',
                    status: 'requested',
                    pickup: {
                        lat: selectedPickupData.lat,
                        lng: selectedPickupData.lng,
                        address: selectedPickupData.address
                    },
                    destination: {
                        lat: selectedDestinationData.lat,
                        lng: selectedDestinationData.lng,
                        address: selectedDestinationData.address
                    },
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                await createTrip(tripData);
                console.log('Nuevo viaje creado:', tripId);
                
                // Cambiar a modo de seguimiento del viaje
                tripSetupPanel.style.display = 'none';
                tripInfoPanel.style.display = 'block';
                
                // Mostrar mensaje de éxito
                showTripCreatedMessage();
                
            } catch (error) {
                console.error('Error creando viaje:', error);
                alert('Error al crear el viaje');
            }
        }

        // Mostrar mensaje de viaje creado
        function showTripCreatedMessage() {
            const message = document.createElement('div');
            message.className = 'trip-created-message';
            message.innerHTML = `
                <div class="message-content">
                    <h3>¡Viaje creado exitosamente!</h3>
                    <p>ID del viaje: <strong>${tripId}</strong></p>
                    <p>Comparte este ID con tu conductor para que pueda unirse.</p>
                    <button onclick="copyTripId()" class="copy-btn">
                        <i class="fas fa-copy"></i>
                        Copiar ID
                    </button>
                </div>
            `;
            
            document.body.appendChild(message);
            
            // Remover mensaje después de 5 segundos
            setTimeout(() => {
                if (message.parentNode) {
                    message.parentNode.removeChild(message);
                }
            }, 5000);
        }

        // Copiar ID del viaje al portapapeles
        function copyTripId() {
            navigator.clipboard.writeText(tripId).then(() => {
                alert('ID del viaje copiado al portapapeles');
            }).catch(() => {
                alert('No se pudo copiar el ID');
            });
        }

        // Hacer la función global para que funcione desde el HTML
        window.copyTripId = copyTripId;

        // Obtener posición actual
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalización no soportada'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            recenterBtn.addEventListener('click', recenterMap);
            googleMapsBtn.addEventListener('click', openInGoogleMaps);
            toggleStepsBtn.addEventListener('click', toggleStepsPanel);
            
            // Event listeners para búsqueda de pickup
            searchPickupBtn.addEventListener('click', searchPickup);
            pickupInput.addEventListener('input', handlePickupInput);
            pickupInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchPickup();
                }
            });
            changePickupBtn.addEventListener('click', resetPickup);
            
            // Event listeners para búsqueda de destino
            searchDestinationBtn.addEventListener('click', searchDestination);
            destinationInput.addEventListener('input', handleDestinationInput);
            destinationInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchDestination();
                }
            });
            changeDestinationBtn.addEventListener('click', resetDestination);
            createTripBtn.addEventListener('click', createTripWithDestination);
            
            // Ocultar sugerencias al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!pickupInput.contains(e.target) && !pickupSuggestions.contains(e.target)) {
                    hidePickupSuggestions();
                }
                if (!destinationInput.contains(e.target) && !destinationSuggestions.contains(e.target)) {
                    hideDestinationSuggestions();
                }
            });
        }

        // Manejar actualizaciones del viaje
        function handleTripUpdate(trip) {
            tripData = trip;
            console.log('Viaje actualizado:', trip);

            if (!trip) {
                alert('Viaje no encontrado');
                window.location.href = 'index.html';
                return;
            }

            updateUI();
            handleTripStatus(trip.status);
        }

        // Manejar presencia del conductor
        function handleDriverPresence(presence) {
            driverPresence = presence;
            console.log('Presencia del conductor:', presence);

            if (presence && mapInstance) {
                // Actualizar marcador del auto
                mapInstance.updateCarMarker({
                    lat: presence.lat,
                    lng: presence.lng,
                    heading: presence.heading || 0
                });

                // Calcular ETA si tenemos ruta
                if (tripData && tripData.routeToPickup) {
                    calculateETA(presence);
                }
            }
        }

        // Calcular tiempo estimado de llegada
        function calculateETA(driverPosition) {
            if (!tripData || !tripData.routeToPickup) return;

            try {
                // Calcular distancia restante
                const distanceToPickup = google.maps.geometry.spherical.computeDistanceBetween(
                    new google.maps.LatLng(driverPosition.lat, driverPosition.lng),
                    new google.maps.LatLng(tripData.pickup.lat, tripData.pickup.lng)
                );

                // Estimación: 2 minutos por km
                const etaMinutes = Math.round((distanceToPickup / 1000) * 2);
                
                if (etaMinutes < 1) {
                    driverEta.textContent = 'Llegando...';
                } else {
                    driverEta.textContent = `${etaMinutes} min`;
                }
            } catch (error) {
                console.error('Error calculando ETA:', error);
                driverEta.textContent = '--';
            }
        }

        // Actualizar UI según el estado del viaje
        function updateUI() {
            if (!tripData) return;

            // Actualizar estado
            const statusText = getStatusText(tripData.status);
            tripStatus.innerHTML = `<i class="fas fa-clock"></i><span>${statusText}</span>`;

            // Mostrar/ocultar información del conductor
            if (['accepted', 'en_route_to_pickup', 'arrived', 'in_progress'].includes(tripData.status)) {
                driverInfo.style.display = 'flex';
                if (tripData.driverId) {
                    driverName.textContent = `Conductor ${tripData.driverId.slice(-4)}`;
                }
            } else {
                driverInfo.style.display = 'none';
            }
            
            // Actualizar instrucciones
            updateInstructions();
            
            // Actualizar lista de pasos
            updateStepsList();
        }

        // Obtener texto del estado
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Esperando conductor...',
                'accepted': 'Conductor aceptó el viaje',
                'en_route_to_pickup': 'Conductor en camino',
                'arrived': 'Conductor llegó',
                'in_progress': 'Viaje en progreso',
                'completed': 'Viaje completado',
                'canceled_by_client': 'Cancelado por ti',
                'canceled_by_driver': 'Cancelado por conductor'
            };
            return statusMap[status] || status;
        }

        // Actualizar instrucciones
        function updateInstructions() {
            if (!tripData) return;

            let instruction = 'Esperando conductor...';
            let routeData = null;

            // Determinar qué ruta mostrar según el estado
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                routeData = tripData.routeToPickup;
                instruction = 'Conductor en camino hacia ti';
            } else if (['arrived', 'in_progress'].includes(tripData.status)) {
                routeData = tripData.routeToDestination;
            }

            if (routeData && routeData.steps && routeData.steps.length > 0) {
                const currentStep = routeData.steps[tripData.currentStepIndex || 0];
                if (currentStep) {
                    instruction = formatInstruction(currentStep);
                }
            }

            nextInstruction.textContent = instruction;
        }

        // Actualizar lista de pasos
        function updateStepsList() {
            if (!tripData) return;

            let routeData = null;
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                routeData = tripData.routeToPickup;
            } else if (['arrived', 'in_progress'].includes(tripData.status)) {
                routeData = tripData.routeToDestination;
            }

            if (!routeData || !routeData.steps) {
                stepsList.innerHTML = '<p>No hay instrucciones disponibles</p>';
                return;
            }

            const currentStepIndex = tripData.currentStepIndex || 0;
            
            stepsList.innerHTML = routeData.steps.map((step, index) => {
                const isActive = index === currentStepIndex;
                const isCompleted = index < currentStepIndex;
                
                return `
                    <div class="step-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                         data-step="${index}">
                        <div class="step-number">${index + 1}</div>
                        <div class="step-content">
                            <div class="step-instruction">${formatInstruction(step)}</div>
                            <div class="step-distance">${step.distance?.text || ''}</div>
                        </div>
                        <div class="step-status">
                            ${isActive ? '<i class="fas fa-play"></i>' : ''}
                            ${isCompleted ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll al paso activo
            const activeStep = stepsList.querySelector('.step-item.active');
            if (activeStep) {
                activeStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Manejar cambios de estado del viaje
        function handleTripStatus(status) {
            switch (status) {
                case 'requested':
                    // Esperar a que el conductor acepte
                    break;
                case 'accepted':
                case 'en_route_to_pickup':
                    // Mostrar ruta al pickup
                    if (tripData.routeToPickup) {
                        mapInstance.renderRoute(tripData.routeToPickup, 'toPickup');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'arrived':
                    // Mostrar ruta al destino
                    if (tripData.routeToDestination) {
                        mapInstance.renderRoute(tripData.routeToDestination, 'toDestination');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'in_progress':
                    // Seguir el viaje en progreso
                    if (tripData.routeToDestination) {
                        mapInstance.renderRoute(tripData.routeToDestination, 'toDestination');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'completed':
                    // Viaje completado
                    alert('¡Viaje completado!');
                    break;
            }
        }

        // Recentrar mapa
        function recenterMap() {
            if (mapInstance && mapInstance.recenter) {
                mapInstance.recenter();
            }
        }

        // Abrir en Google Maps
        function openInGoogleMaps() {
            if (!tripData) return;

            let origin, destination;
            
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                origin = `${tripData.pickup.lat},${tripData.pickup.lng}`;
                destination = `${tripData.pickup.lat},${tripData.pickup.lng}`;
            } else {
                origin = `${tripData.pickup.lat},${tripData.pickup.lng}`;
                destination = `${tripData.destination.lat},${tripData.destination.lng}`;
            }

            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving&dir_action=navigate`;
            window.open(url, '_blank');
        }

        // Alternar panel de pasos
        function toggleStepsPanel() {
            stepsPanel.classList.toggle('collapsed');
            const icon = toggleStepsBtn.querySelector('i');
            if (stepsPanel.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-chevron-left';
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
