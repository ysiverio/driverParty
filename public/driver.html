<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriverParty - Conductor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Barra superior con próxima instrucción -->
    <div id="instruction-bar" class="instruction-bar">
        <div class="instruction-content">
            <i class="fas fa-route"></i>
            <span id="next-instruction">Esperando instrucciones...</span>
        </div>
        <div class="instruction-actions">
            <button id="recenter-btn" class="action-btn" title="Recentar mapa">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button id="google-maps-btn" class="action-btn" title="Abrir en Google Maps">
                <i class="fab fa-google"></i>
            </button>
        </div>
    </div>

    <!-- Panel lateral con lista de pasos -->
    <div id="steps-panel" class="steps-panel">
        <div class="steps-header">
            <h3>Instrucciones de navegación</h3>
            <button id="toggle-steps-btn" class="toggle-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div id="steps-list" class="steps-list">
            <!-- Los pasos se cargarán dinámicamente -->
        </div>
    </div>

    <!-- Mapa principal -->
    <div id="map" class="map-container"></div>

    <!-- Panel de control del conductor -->
    <div id="driver-controls" class="driver-controls">
        <div class="control-buttons">
            <button id="accept-trip-btn" class="control-btn primary">
                <i class="fas fa-check"></i>
                Aceptar viaje
            </button>
            <button id="arrived-btn" class="control-btn secondary" style="display: none;">
                <i class="fas fa-map-marker-alt"></i>
                Llegué
            </button>
            <button id="start-trip-btn" class="control-btn primary" style="display: none;">
                <i class="fas fa-play"></i>
                Iniciar recorrido
            </button>
            <button id="finish-trip-btn" class="control-btn danger" style="display: none;">
                <i class="fas fa-flag-checkered"></i>
                Finalizar
            </button>
        </div>
        
        <div class="trip-info">
            <div id="trip-status" class="status-indicator">
                <i class="fas fa-clock"></i>
                <span>Esperando...</span>
            </div>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../src/firebase.js"></script>
    <script type="module" src="../src/maps.js"></script>
    <script type="module" src="../src/directions.js"></script>
    <script type="module" src="../src/location.js"></script>
    <script type="module" src="../src/trips.js"></script>
    <script type="module" src="../src/utils.js"></script>
    
    <script type="module">
        import { db, auth } from '../src/firebase.js';
        import { createMap } from '../src/maps.js';
        import { fetchRoute } from '../src/directions.js';
        import { watchDriverPosition } from '../src/location.js';
        import { getTrip, listenTrip, updateTrip, publishDriverPresence } from '../src/trips.js';
        import { stripHtml, formatInstruction } from '../src/utils.js';

        // Estado global
        let tripId = null;
        let tripData = null;
        let mapInstance = null;
        let locationWatcher = null;
        let currentStepIndex = 0;
        let isDriving = false;

        // Elementos del DOM
        const instructionBar = document.getElementById('instruction-bar');
        const nextInstruction = document.getElementById('next-instruction');
        const stepsPanel = document.getElementById('steps-panel');
        const stepsList = document.getElementById('steps-list');
        const toggleStepsBtn = document.getElementById('toggle-steps-btn');
        const mapContainer = document.getElementById('map');
        const driverControls = document.getElementById('driver-controls');
        const acceptTripBtn = document.getElementById('accept-trip-btn');
        const arrivedBtn = document.getElementById('arrived-btn');
        const startTripBtn = document.getElementById('start-trip-btn');
        const finishTripBtn = document.getElementById('finish-trip-btn');
        const recenterBtn = document.getElementById('recenter-btn');
        const googleMapsBtn = document.getElementById('google-maps-btn');
        const tripStatus = document.getElementById('trip-status');
        const loading = document.getElementById('loading');

        // Inicialización
        async function init() {
            // Obtener tripId de la URL
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            
            if (!tripId) {
                alert('No se proporcionó un ID de viaje');
                window.location.href = 'index.html';
                return;
            }

            // Inicializar mapa
            try {
                mapInstance = await createMap('map');
                console.log('Mapa inicializado');
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                alert('Error al cargar el mapa');
                return;
            }

            // Escuchar cambios en el viaje
            listenTrip(tripId, handleTripUpdate);
            
            // Event listeners
            setupEventListeners();
            
            // Ocultar loading
            loading.style.display = 'none';
        }

        // Configurar event listeners
        function setupEventListeners() {
            acceptTripBtn.addEventListener('click', acceptTrip);
            arrivedBtn.addEventListener('click', markArrived);
            startTripBtn.addEventListener('click', startTrip);
            finishTripBtn.addEventListener('click', finishTrip);
            recenterBtn.addEventListener('click', recenterMap);
            googleMapsBtn.addEventListener('click', openInGoogleMaps);
            toggleStepsBtn.addEventListener('click', toggleStepsPanel);
        }

        // Manejar actualizaciones del viaje
        function handleTripUpdate(trip) {
            tripData = trip;
            console.log('Viaje actualizado:', trip);

            if (!trip) {
                alert('Viaje no encontrado');
                window.location.href = 'index.html';
                return;
            }

            updateUI();
            handleTripStatus(trip.status);
        }

        // Actualizar UI según el estado del viaje
        function updateUI() {
            if (!tripData) return;

            // Actualizar estado
            const statusText = getStatusText(tripData.status);
            tripStatus.innerHTML = `<i class="fas fa-clock"></i><span>${statusText}</span>`;

            // Actualizar botones según el estado
            updateButtons();
            
            // Actualizar instrucciones
            updateInstructions();
            
            // Actualizar lista de pasos
            updateStepsList();
        }

        // Obtener texto del estado
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Solicitado',
                'accepted': 'Aceptado',
                'en_route_to_pickup': 'En camino al pickup',
                'arrived': 'Llegué al pickup',
                'in_progress': 'Viaje en progreso',
                'completed': 'Completado',
                'canceled_by_client': 'Cancelado por cliente',
                'canceled_by_driver': 'Cancelado por conductor'
            };
            return statusMap[status] || status;
        }

        // Actualizar botones según el estado
        function updateButtons() {
            const status = tripData.status;
            
            // Ocultar todos los botones
            acceptTripBtn.style.display = 'none';
            arrivedBtn.style.display = 'none';
            startTripBtn.style.display = 'none';
            finishTripBtn.style.display = 'none';

            // Mostrar botones según el estado
            switch (status) {
                case 'requested':
                    acceptTripBtn.style.display = 'block';
                    break;
                case 'accepted':
                case 'en_route_to_pickup':
                    arrivedBtn.style.display = 'block';
                    break;
                case 'arrived':
                    startTripBtn.style.display = 'block';
                    break;
                case 'in_progress':
                    finishTripBtn.style.display = 'block';
                    break;
            }
        }

        // Actualizar instrucciones
        function updateInstructions() {
            if (!tripData) return;

            let instruction = 'Esperando instrucciones...';
            let routeData = null;

            // Determinar qué ruta mostrar según el estado
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                routeData = tripData.routeToPickup;
            } else if (['arrived', 'in_progress'].includes(tripData.status)) {
                routeData = tripData.routeToDestination;
            }

            if (routeData && routeData.steps && routeData.steps.length > 0) {
                const currentStep = routeData.steps[tripData.currentStepIndex || 0];
                if (currentStep) {
                    instruction = formatInstruction(currentStep);
                }
            }

            nextInstruction.textContent = instruction;
        }

        // Actualizar lista de pasos
        function updateStepsList() {
            if (!tripData) return;

            let routeData = null;
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                routeData = tripData.routeToPickup;
            } else if (['arrived', 'in_progress'].includes(tripData.status)) {
                routeData = tripData.routeToDestination;
            }

            if (!routeData || !routeData.steps) {
                stepsList.innerHTML = '<p>No hay instrucciones disponibles</p>';
                return;
            }

            const currentStepIndex = tripData.currentStepIndex || 0;
            
            stepsList.innerHTML = routeData.steps.map((step, index) => {
                const isActive = index === currentStepIndex;
                const isCompleted = index < currentStepIndex;
                
                return `
                    <div class="step-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                         data-step="${index}">
                        <div class="step-number">${index + 1}</div>
                        <div class="step-content">
                            <div class="step-instruction">${formatInstruction(step)}</div>
                            <div class="step-distance">${step.distance?.text || ''}</div>
                        </div>
                        <div class="step-status">
                            ${isActive ? '<i class="fas fa-play"></i>' : ''}
                            ${isCompleted ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll al paso activo
            const activeStep = stepsList.querySelector('.step-item.active');
            if (activeStep) {
                activeStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Manejar cambios de estado del viaje
        function handleTripStatus(status) {
            switch (status) {
                case 'requested':
                    // Esperar a que el conductor acepte
                    break;
                case 'accepted':
                case 'en_route_to_pickup':
                    // Mostrar ruta al pickup
                    if (tripData.routeToPickup) {
                        mapInstance.renderRoute(tripData.routeToPickup, 'toPickup');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'arrived':
                    // Mostrar ruta al destino
                    if (tripData.routeToDestination) {
                        mapInstance.renderRoute(tripData.routeToDestination, 'toDestination');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'in_progress':
                    // Iniciar seguimiento de posición
                    startLocationTracking();
                    break;
                case 'completed':
                    // Finalizar
                    stopLocationTracking();
                    alert('Viaje completado');
                    break;
            }
        }

        // Aceptar viaje
        async function acceptTrip() {
            try {
                // Obtener ubicación actual
                const position = await getCurrentPosition();
                
                // Calcular ruta al pickup
                const route = await fetchRoute({
                    origin: {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    },
                    destination: tripData.pickup,
                    travelMode: 'DRIVING'
                });

                // Actualizar viaje
                await updateTrip(tripId, {
                    status: 'en_route_to_pickup',
                    routeToPickup: route,
                    currentStepIndex: 0
                });

                console.log('Viaje aceptado');
            } catch (error) {
                console.error('Error aceptando viaje:', error);
                alert('Error al aceptar el viaje');
            }
        }

        // Marcar como llegado
        async function markArrived() {
            try {
                // Validar que pickup y destination tengan la estructura correcta
                console.log('Pickup data:', tripData.pickup);
                console.log('Destination data:', tripData.destination);
                
                if (!tripData.pickup || !tripData.pickup.lat || !tripData.pickup.lng) {
                    throw new Error('Pickup location is missing or invalid');
                }
                
                if (!tripData.destination || !tripData.destination.lat || !tripData.destination.lng) {
                    throw new Error('Destination location is missing or invalid');
                }
                
                // Calcular ruta al destino
                const route = await fetchRoute({
                    origin: {
                        lat: parseFloat(tripData.pickup.lat),
                        lng: parseFloat(tripData.pickup.lng)
                    },
                    destination: {
                        lat: parseFloat(tripData.destination.lat),
                        lng: parseFloat(tripData.destination.lng)
                    },
                    travelMode: 'DRIVING'
                });

                // Actualizar viaje
                await updateTrip(tripId, {
                    status: 'arrived',
                    routeToDestination: route,
                    currentStepIndex: 0
                });

                console.log('Marcado como llegado');
            } catch (error) {
                console.error('Error marcando llegada:', error);
                alert('Error al marcar llegada');
            }
        }

        // Iniciar viaje
        async function startTrip() {
            try {
                await updateTrip(tripId, {
                    status: 'in_progress'
                });

                console.log('Viaje iniciado');
            } catch (error) {
                console.error('Error iniciando viaje:', error);
                alert('Error al iniciar el viaje');
            }
        }

        // Finalizar viaje
        async function finishTrip() {
            try {
                stopLocationTracking();
                
                // Calcular métricas finales
                const metrics = calculateFinalMetrics();
                
                await updateTrip(tripId, {
                    status: 'completed',
                    metrics: metrics
                });

                console.log('Viaje finalizado');
            } catch (error) {
                console.error('Error finalizando viaje:', error);
                alert('Error al finalizar el viaje');
            }
        }

        // Iniciar seguimiento de posición
        function startLocationTracking() {
            if (locationWatcher) return;

            locationWatcher = watchDriverPosition({
                onUpdate: async (position) => {
                    // Publicar posición
                    await publishDriverPresence(tripId, {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        heading: position.coords.heading || 0,
                        speed: position.coords.speed || 0,
                        ts: Date.now()
                    });

                    // Actualizar marcador del auto
                    mapInstance.updateCarMarker({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        heading: position.coords.heading || 0
                    });

                    // Verificar si debe avanzar el paso
                    checkStepAdvancement(position);
                }
            });

            isDriving = true;
        }

        // Detener seguimiento de posición
        function stopLocationTracking() {
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
                locationWatcher = null;
            }
            isDriving = false;
        }

        // Verificar avance de paso
        function checkStepAdvancement(position) {
            if (!tripData || !tripData.routeToDestination) return;

            const currentStep = tripData.routeToDestination.steps[tripData.currentStepIndex];
            if (!currentStep) return;

            // Calcular distancia al final del paso actual
            const distanceToStepEnd = google.maps.geometry.spherical.computeDistanceBetween(
                new google.maps.LatLng(position.coords.latitude, position.coords.longitude),
                currentStep.end_location
            );

            // Si está a menos de 30 metros del final del paso, avanzar
            if (distanceToStepEnd < 30) {
                const nextStepIndex = (tripData.currentStepIndex || 0) + 1;
                if (nextStepIndex < tripData.routeToDestination.steps.length) {
                    updateTrip(tripId, {
                        currentStepIndex: nextStepIndex
                    });
                }
            }
        }

        // Obtener posición actual
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        // Calcular métricas finales
        function calculateFinalMetrics() {
            // Implementar cálculo de métricas reales
            return {
                distanceMeters: tripData.metrics?.distanceMeters || 0,
                durationSec: tripData.metrics?.durationSec || 0,
                actualDistanceMeters: tripData.metrics?.actualDistanceMeters || 0,
                actualDurationSec: tripData.metrics?.actualDurationSec || 0
            };
        }

        // Recentrar mapa
        function recenterMap() {
            if (mapInstance && mapInstance.recenter) {
                mapInstance.recenter();
            }
        }

        // Abrir en Google Maps
        function openInGoogleMaps() {
            if (!tripData) return;

            let origin, destination;
            
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                origin = `${tripData.pickup.lat},${tripData.pickup.lng}`;
                destination = `${tripData.pickup.lat},${tripData.pickup.lng}`;
            } else {
                origin = `${tripData.pickup.lat},${tripData.pickup.lng}`;
                destination = `${tripData.destination.lat},${tripData.destination.lng}`;
            }

            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving&dir_action=navigate`;
            window.open(url, '_blank');
        }

        // Alternar panel de pasos
        function toggleStepsPanel() {
            stepsPanel.classList.toggle('collapsed');
            const icon = toggleStepsBtn.querySelector('i');
            if (stepsPanel.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-chevron-left';
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
