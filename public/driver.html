<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DriverParty - Conductor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Barra superior con próxima instrucción -->
    <div id="instruction-bar" class="instruction-bar">
        <div class="instruction-content">
            <i class="fas fa-route"></i>
            <span id="next-instruction">Esperando instrucciones...</span>
        </div>
        <div class="instruction-actions">
            <button id="recenter-btn" class="action-btn" title="Recentar mapa">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button id="google-maps-btn" class="action-btn" title="Abrir en Google Maps">
                <i class="fab fa-google"></i>
            </button>
        </div>
    </div>

    <!-- Panel lateral con lista de pasos -->
    <div id="steps-panel" class="steps-panel">
        <div class="steps-header">
            <h3>Instrucciones de navegación</h3>
            <button id="toggle-steps-btn" class="toggle-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div id="steps-list" class="steps-list">
            <!-- Los pasos se cargarán dinámicamente -->
        </div>
    </div>

    <!-- Mapa principal -->
    <div id="map" class="map-container"></div>

    <!-- Panel de viajes disponibles -->
    <div id="available-trips-panel" class="available-trips-panel">
        <div class="panel-header">
            <h3>Viajes disponibles</h3>
            <button id="refresh-trips-btn" class="refresh-btn">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        <div id="trips-list" class="trips-list">
            <!-- Los viajes se cargarán dinámicamente -->
        </div>
    </div>

    <!-- Panel de control del conductor -->
    <div id="driver-controls" class="driver-controls" style="display: none;">
        <div class="control-buttons">
            <button id="accept-trip-btn" class="control-btn primary">
                <i class="fas fa-check"></i>
                Aceptar viaje
            </button>
            <button id="arrived-btn" class="control-btn secondary" style="display: none;">
                <i class="fas fa-map-marker-alt"></i>
                Llegué
            </button>
            <button id="start-trip-btn" class="control-btn primary" style="display: none;">
                <i class="fas fa-play"></i>
                Iniciar recorrido
            </button>
            <button id="finish-trip-btn" class="control-btn danger" style="display: none;">
                <i class="fas fa-flag-checkered"></i>
                Finalizar
            </button>
        </div>
        
        <div class="trip-info">
            <div id="trip-status" class="status-indicator">
                <i class="fas fa-clock"></i>
                <span>Esperando...</span>
            </div>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loading" class="loading-overlay">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Cargando...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="../src/firebase.js"></script>
    <script type="module" src="../src/maps.js"></script>
    <script type="module" src="../src/directions.js"></script>
    <script type="module" src="../src/location.js"></script>
    <script type="module" src="../src/trips.js"></script>
    <script type="module" src="../src/utils.js"></script>
    
    <script type="module">
        import { db, auth } from '../src/firebase.js';
        import { createMap } from '../src/maps.js';
        import { fetchRoute } from '../src/directions.js';
        import { watchDriverPosition } from '../src/location.js';
        import { getTrip, listenTrip, updateTrip, publishDriverPresence } from '../src/trips.js';
        import { stripHtml, formatInstruction } from '../src/utils.js';

        // Estado global
        let tripId = null;
        let tripData = null;
        let mapInstance = null;
        let locationWatcher = null;
        let currentStepIndex = 0;
        let isDriving = false;
        let availableTripsListener = null;

        // Elementos del DOM
        const instructionBar = document.getElementById('instruction-bar');
        const nextInstruction = document.getElementById('next-instruction');
        const stepsPanel = document.getElementById('steps-panel');
        const stepsList = document.getElementById('steps-list');
        const toggleStepsBtn = document.getElementById('toggle-steps-btn');
        const mapContainer = document.getElementById('map');
        const availableTripsPanel = document.getElementById('available-trips-panel');
        const tripsList = document.getElementById('trips-list');
        const refreshTripsBtn = document.getElementById('refresh-trips-btn');
        const driverControls = document.getElementById('driver-controls');
        const acceptTripBtn = document.getElementById('accept-trip-btn');
        const arrivedBtn = document.getElementById('arrived-btn');
        const startTripBtn = document.getElementById('start-trip-btn');
        const finishTripBtn = document.getElementById('finish-trip-btn');
        const recenterBtn = document.getElementById('recenter-btn');
        const googleMapsBtn = document.getElementById('google-maps-btn');
        const tripStatus = document.getElementById('trip-status');
        const loading = document.getElementById('loading');

        // Inicialización
        async function init() {
            // Obtener tripId de la URL (opcional)
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            
            // Inicializar mapa
            try {
                mapInstance = await createMap('map');
                console.log('Mapa inicializado');
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                alert('Error al cargar el mapa');
                return;
            }

            if (tripId) {
                // Unirse a un viaje específico
                joinSpecificTrip();
            } else {
                // Mostrar viajes disponibles
                showAvailableTrips();
            }
            
            // Event listeners
            setupEventListeners();
            
            // Ocultar loading
            loading.style.display = 'none';
        }

        // Unirse a un viaje específico
        function joinSpecificTrip() {
            availableTripsPanel.style.display = 'none';
            driverControls.style.display = 'block';
            
            // Escuchar cambios en el viaje
            listenTrip(tripId, handleTripUpdate);
        }

        // Mostrar viajes disponibles
        function showAvailableTrips() {
            availableTripsPanel.style.display = 'block';
            driverControls.style.display = 'none';
            
            // Centrar mapa en Montevideo
            const defaultLocation = { lat: -34.9011, lng: -56.1645 };
            mapInstance.map.setCenter(defaultLocation);
            mapInstance.map.setZoom(12);
            
            // Cargar viajes disponibles
            loadAvailableTrips();
        }

        // Cargar viajes disponibles
        async function loadAvailableTrips() {
            try {
                const { collection, query, where, onSnapshot } = await import('../src/firebase.js');
                
                // Escuchar viajes con estado 'requested'
                const tripsQuery = query(
                    collection(db, 'trips'),
                    where('status', '==', 'requested')
                );
                
                availableTripsListener = onSnapshot(tripsQuery, (snapshot) => {
                    const trips = [];
                    snapshot.forEach((doc) => {
                        trips.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    displayAvailableTrips(trips);
                });
                
            } catch (error) {
                console.error('Error cargando viajes disponibles:', error);
                tripsList.innerHTML = '<p>Error al cargar viajes</p>';
            }
        }

        // Mostrar viajes disponibles
        function displayAvailableTrips(trips) {
            if (trips.length === 0) {
                tripsList.innerHTML = '<p class="no-trips">No hay viajes disponibles</p>';
                return;
            }
            
            tripsList.innerHTML = trips.map(trip => `
                <div class="trip-item" data-trip-id="${trip.id}">
                    <div class="trip-header">
                        <h4>Viaje #${trip.id.slice(-6)}</h4>
                        <span class="trip-time">${formatTime(trip.createdAt)}</span>
                    </div>
                    <div class="trip-details">
                        <div class="trip-location">
                            <i class="fas fa-map-marker-alt pickup"></i>
                            <span>${trip.pickup?.address || 'Punto de partida'}</span>
                        </div>
                        <div class="trip-location">
                            <i class="fas fa-map-marker-alt destination"></i>
                            <span>${trip.destination?.address || 'Destino'}</span>
                        </div>
                    </div>
                    <button class="accept-trip-btn" onclick="acceptAvailableTrip('${trip.id}')">
                        <i class="fas fa-check"></i>
                        Aceptar
                    </button>
                </div>
            `).join('');
        }

        // Formatear tiempo
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // Aceptar viaje disponible
        window.acceptAvailableTrip = function(tripId) {
            if (confirm('¿Aceptar este viaje?')) {
                joinTrip(tripId);
            }
        };

        // Unirse a un viaje
        function joinTrip(newTripId) {
            tripId = newTripId;
            
            // Limpiar listener de viajes disponibles
            if (availableTripsListener) {
                availableTripsListener();
                availableTripsListener = null;
            }
            
            // Ocultar panel de viajes disponibles
            availableTripsPanel.style.display = 'none';
            driverControls.style.display = 'block';
            
            // Escuchar cambios en el viaje
            listenTrip(tripId, handleTripUpdate);
        }

        // Configurar event listeners
        function setupEventListeners() {
            refreshTripsBtn.addEventListener('click', loadAvailableTrips);
            acceptTripBtn.addEventListener('click', acceptTrip);
            arrivedBtn.addEventListener('click', markArrived);
            startTripBtn.addEventListener('click', startTrip);
            finishTripBtn.addEventListener('click', finishTrip);
            recenterBtn.addEventListener('click', recenterMap);
            googleMapsBtn.addEventListener('click', openInGoogleMaps);
            toggleStepsBtn.addEventListener('click', toggleStepsPanel);
        }

        // Manejar actualizaciones del viaje
        function handleTripUpdate(trip) {
            tripData = trip;
            console.log('Viaje actualizado:', trip);

            if (!trip) {
                alert('Viaje no encontrado');
                showAvailableTrips();
                return;
            }

            updateUI();
            handleTripStatus(trip.status);
        }

        // Actualizar UI según el estado del viaje
        function updateUI() {
            if (!tripData) return;

            // Actualizar estado
            const statusText = getStatusText(tripData.status);
            tripStatus.innerHTML = `<i class="fas fa-clock"></i><span>${statusText}</span>`;

            // Actualizar botones según el estado
            updateButtons();
            
            // Actualizar instrucciones
            updateInstructions();
            
            // Actualizar lista de pasos
            updateStepsList();
        }

        // Obtener texto del estado
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Solicitado',
                'accepted': 'Aceptado',
                'en_route_to_pickup': 'En camino al cliente',
                'arrived': 'Llegué al cliente',
                'in_progress': 'Viaje en progreso',
                'completed': 'Completado',
                'canceled_by_client': 'Cancelado por cliente',
                'canceled_by_driver': 'Cancelado por conductor'
            };
            return statusMap[status] || status;
        }

        // Actualizar botones según el estado
        function updateButtons() {
            const status = tripData.status;
            
            // Ocultar todos los botones
            acceptTripBtn.style.display = 'none';
            arrivedBtn.style.display = 'none';
            startTripBtn.style.display = 'none';
            finishTripBtn.style.display = 'none';
            
            // Mostrar botones según el estado
            switch (status) {
                case 'requested':
                    acceptTripBtn.style.display = 'block';
                    break;
                case 'accepted':
                case 'en_route_to_pickup':
                    arrivedBtn.style.display = 'block';
                    break;
                case 'arrived':
                    startTripBtn.style.display = 'block';
                    break;
                case 'in_progress':
                    finishTripBtn.style.display = 'block';
                    break;
            }
        }

        // Aceptar viaje
        async function acceptTrip() {
            if (!tripData) return;
            
            try {
                // Obtener posición actual del conductor
                const position = await getCurrentPosition();
                
                console.log('Driver position:', position);
                console.log('Trip pickup:', tripData.pickup);
                
                // Calcular ruta al pickup
                const routeToPickup = await fetchRoute({
                    origin: { lat: position.coords.latitude, lng: position.coords.longitude },
                    destination: tripData.pickup
                });
                
                // Actualizar viaje
                await updateTrip(tripId, {
                    status: 'accepted',
                    driverId: auth.currentUser?.uid || 'driver_' + Date.now(),
                    routeToPickup: routeToPickup,
                    currentStepIndex: 0
                });
                
                console.log('Viaje aceptado');
                
            } catch (error) {
                console.error('Error aceptando viaje:', error);
                alert('Error al aceptar el viaje: ' + error.message);
            }
        }

        // Marcar llegada al cliente
        async function markArrived() {
            if (!tripData) return;
            
            try {
                console.log('Pickup location:', tripData.pickup);
                console.log('Destination location:', tripData.destination);
                
                // Calcular ruta al destino
                const routeToDestination = await fetchRoute({
                    origin: tripData.pickup,
                    destination: tripData.destination
                });
                
                // Actualizar viaje
                await updateTrip(tripId, {
                    status: 'arrived',
                    routeToDestination: routeToDestination,
                    currentStepIndex: 0
                });
                
                console.log('Llegada marcada');
                
            } catch (error) {
                console.error('Error marcando llegada:', error);
                alert('Error al marcar llegada: ' + error.message);
            }
        }

        // Iniciar viaje
        async function startTrip() {
            if (!tripData) return;
            
            try {
                // Iniciar seguimiento de posición
                locationWatcher = await watchDriverPosition((position) => {
                    publishDriverPresence(tripId, {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        heading: position.coords.heading || 0
                    });
                });
                
                // Actualizar estado
                await updateTrip(tripId, {
                    status: 'in_progress'
                });
                
                isDriving = true;
                console.log('Viaje iniciado');
                
            } catch (error) {
                console.error('Error iniciando viaje:', error);
                alert('Error al iniciar el viaje');
            }
        }

        // Finalizar viaje
        async function finishTrip() {
            if (!tripData) return;
            
            try {
                // Detener seguimiento de posición
                if (locationWatcher) {
                    locationWatcher();
                    locationWatcher = null;
                }
                
                // Actualizar estado
                await updateTrip(tripId, {
                    status: 'completed'
                });
                
                isDriving = false;
                console.log('Viaje finalizado');
                
                // Volver a mostrar viajes disponibles
                setTimeout(() => {
                    showAvailableTrips();
                }, 2000);
                
            } catch (error) {
                console.error('Error finalizando viaje:', error);
                alert('Error al finalizar el viaje');
            }
        }

        // Obtener posición actual
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalización no soportada'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        // Actualizar instrucciones
        function updateInstructions() {
            if (!tripData) return;

            let instruction = 'Esperando instrucciones...';
            let routeData = null;

            // Determinar qué ruta mostrar según el estado
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                routeData = tripData.routeToPickup;
                instruction = 'Dirígete al cliente';
            } else if (['arrived', 'in_progress'].includes(tripData.status)) {
                routeData = tripData.routeToDestination;
                instruction = 'Dirígete al destino';
            }

            if (routeData && routeData.steps && routeData.steps.length > 0) {
                const currentStep = routeData.steps[tripData.currentStepIndex || 0];
                if (currentStep) {
                    instruction = formatInstruction(currentStep);
                }
            }

            nextInstruction.textContent = instruction;
        }

        // Actualizar lista de pasos
        function updateStepsList() {
            if (!tripData) return;

            let routeData = null;
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                routeData = tripData.routeToPickup;
            } else if (['arrived', 'in_progress'].includes(tripData.status)) {
                routeData = tripData.routeToDestination;
            }

            if (!routeData || !routeData.steps) {
                stepsList.innerHTML = '<p>No hay instrucciones disponibles</p>';
                return;
            }

            const currentStepIndex = tripData.currentStepIndex || 0;
            
            stepsList.innerHTML = routeData.steps.map((step, index) => {
                const isActive = index === currentStepIndex;
                const isCompleted = index < currentStepIndex;
                
                return `
                    <div class="step-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" 
                         data-step="${index}">
                        <div class="step-number">${index + 1}</div>
                        <div class="step-content">
                            <div class="step-instruction">${formatInstruction(step)}</div>
                            <div class="step-distance">${step.distance?.text || ''}</div>
                        </div>
                        <div class="step-status">
                            ${isActive ? '<i class="fas fa-play"></i>' : ''}
                            ${isCompleted ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll al paso activo
            const activeStep = stepsList.querySelector('.step-item.active');
            if (activeStep) {
                activeStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Manejar cambios de estado del viaje
        function handleTripStatus(status) {
            switch (status) {
                case 'requested':
                    // Esperar a que el conductor acepte
                    break;
                case 'accepted':
                case 'en_route_to_pickup':
                    // Mostrar ruta al pickup
                    if (tripData.routeToPickup) {
                        mapInstance.renderRoute(tripData.routeToPickup, 'toPickup');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'arrived':
                    // Mostrar ruta al destino
                    if (tripData.routeToDestination) {
                        mapInstance.renderRoute(tripData.routeToDestination, 'toDestination');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'in_progress':
                    // Seguir el viaje en progreso
                    if (tripData.routeToDestination) {
                        mapInstance.renderRoute(tripData.routeToDestination, 'toDestination');
                        mapInstance.setCameraToDrivingView();
                    }
                    break;
                case 'completed':
                    // Viaje completado
                    alert('¡Viaje completado!');
                    break;
            }
        }

        // Recentrar mapa
        function recenterMap() {
            if (mapInstance && mapInstance.recenter) {
                mapInstance.recenter();
            }
        }

        // Abrir en Google Maps
        function openInGoogleMaps() {
            if (!tripData) return;

            let origin, destination;
            
            if (['accepted', 'en_route_to_pickup'].includes(tripData.status)) {
                origin = `${tripData.pickup.lat},${tripData.pickup.lng}`;
                destination = `${tripData.pickup.lat},${tripData.pickup.lng}`;
            } else {
                origin = `${tripData.pickup.lat},${tripData.pickup.lng}`;
                destination = `${tripData.destination.lat},${tripData.destination.lng}`;
            }

            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving&dir_action=navigate`;
            window.open(url, '_blank');
        }

        // Alternar panel de pasos
        function toggleStepsPanel() {
            stepsPanel.classList.toggle('collapsed');
            const icon = toggleStepsBtn.querySelector('i');
            if (stepsPanel.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-chevron-left';
            }
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
